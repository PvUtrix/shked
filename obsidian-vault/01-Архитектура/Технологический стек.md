# Технологический стек Шкед

> Полный обзор технологий, используемых в проекте ШКЕД

## Общая архитектура

Шкед построен как **full-stack монолит** на базе Next.js 14 с серверными и клиентскими компонентами.

```
┌─────────────────────────────────────────┐
│         Browser (Client)                │
│  React 18 + TypeScript + Tailwind CSS   │
└──────────────┬──────────────────────────┘
               │ HTTPS
               ↓
┌─────────────────────────────────────────┐
│         Next.js 14 App Router           │
│  ┌────────────────────────────────────┐ │
│  │   Server Components (RSC)          │ │
│  │   Client Components                │ │
│  │   API Routes                       │ │
│  └────────────────────────────────────┘ │
└──────────────┬──────────────────────────┘
               │
        ┌──────┴──────┐
        ↓             ↓
┌──────────────┐  ┌────────────────────┐
│  PostgreSQL  │  │  External APIs     │
│  + Prisma    │  │  - Telegram Bot    │
│              │  │  - GigaChat        │
└──────────────┘  └────────────────────┘
```

## Frontend Stack

### Core

#### Next.js 14.2
**Версия**: `^14.2.0`  
**Роль**: Full-stack React framework  
**ADR**: [[ADR-001 Next.js 14 App Router]]

**Использование**:
- App Router для роутинга
- Server Components для SSR
- Client Components для интерактивности
- API Routes для backend
- Middleware для auth

**Конфигурация**: `next.config.js`

#### React 18
**Версия**: `^18.0.0`  
**Роль**: UI библиотека

**Особенности**:
- React Server Components (RSC)
- Concurrent features
- Automatic batching
- Suspense для загрузки

#### TypeScript 5.2
**Версия**: `^5.2.0`  
**Роль**: Type-safe разработка  
**ADR**: Неявное решение (стандарт индустрии)

**Конфигурация**: `tsconfig.json`

```json
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "strict": true,
    "noUncheckedIndexedAccess": true
  }
}
```

### UI Framework

#### Tailwind CSS 3.4
**Версия**: `^3.4.0`  
**Роль**: Utility-first CSS framework  
**ADR**: [[ADR-007 Tailwind + Radix UI]]

**Плагины**:
- `tailwindcss-animate` - анимации
- `@tailwindcss/typography` - типографика

**Конфигурация**: `tailwind.config.ts`

#### Radix UI
**Роль**: Headless UI компоненты  
**ADR**: [[ADR-007 Tailwind + Radix UI]]

**Компоненты**:
- `@radix-ui/react-dialog` - модальные окна
- `@radix-ui/react-dropdown-menu` - выпадающие меню
- `@radix-ui/react-select` - селекты
- `@radix-ui/react-tabs` - табы
- `@radix-ui/react-toast` - уведомления (через sonner)
- И другие...

**Папка**: `components/ui/`

#### shadcn/ui
**Роль**: Копируемые компоненты на базе Radix UI

**Использование**:
```bash
npx shadcn-ui@latest add button
npx shadcn-ui@latest add dialog
```

**Конфигурация**: `components.json`

### Forms & Validation

#### React Hook Form
**Версия**: `^7.0.0`  
**Роль**: Управление формами

```typescript
const form = useForm({
  resolver: zodResolver(schema)
})
```

#### Zod
**Версия**: `^3.22.0`  
**Роль**: Schema validation

```typescript
const userSchema = z.object({
  email: z.string().email(),
  password: z.string().min(6)
})
```

### State Management

#### Zustand (опционально)
**Версия**: `^4.0.0`  
**Роль**: Global state (минимальное использование)

**Файл**: `lib/stores/animation-store.ts`

> Большая часть состояния управляется через React Server Components и нет нужды в глобальном стейте.

## Backend Stack

### Database

#### PostgreSQL 12+
**Версия**: `≥12`  
**Роль**: Основная СУБД

**Особенности**:
- Relational database
- JSONB для гибких полей
- Full-text search (планируется)
- Транзакции

#### Prisma ORM 6.7
**Версия**: `^6.7.0`  
**Роль**: Database toolkit  
**ADR**: [[ADR-002 Prisma ORM]]

**Компоненты**:
- Prisma Client - type-safe queries
- Prisma Migrate - migrations
- Prisma Studio - DB GUI

**Файлы**:
- `prisma/schema.prisma` - схема
- `lib/db.ts` - клиент

### Authentication

#### NextAuth.js 4.24
**Версия**: `^4.24.0`  
**Роль**: Authentication framework  
**ADR**: [[ADR-003 NextAuth.js аутентификация]]

**Провайдеры**:
- Credentials (email + password)
- Возможность добавить OAuth (Google, GitHub)

**Конфигурация**: `lib/auth.ts`

**Стратегия**: JWT sessions

```typescript
session: {
  strategy: 'jwt',
  maxAge: 30 * 24 * 60 * 60 // 30 дней
}
```

#### bcrypt
**Версия**: `^5.1.0`  
**Роль**: Password hashing

```typescript
const hash = await bcrypt.hash(password, 10)
const isValid = await bcrypt.compare(password, hash)
```

## External Integrations

### Telegram Bot API
**Роль**: Интеграция Telegram бота  
**ADR**: [[ADR-004 Telegram интеграция]]

**Библиотека**: `node-telegram-bot-api` или прямые fetch запросы

**Endpoints**:
- `POST /api/telegram/webhook` - получение updates
- Telegram Bot API - отправка сообщений

**Файлы**: `lib/telegram/`

### GigaChat API (Сбер)
**Роль**: LLM для обработки естественного языка  
**ADR**: [[ADR-004 Telegram интеграция]]

**API**: `https://gigachat.devices.sberbank.ru/api/v1/chat/completions`

**Использование**:
```typescript
const response = await fetch(gigaChatUrl, {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${apiKey}`
  },
  body: JSON.stringify({
    model: 'GigaChat',
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: userMessage }
    ]
  })
})
```

**Файл**: `lib/telegram/llm.ts`

## Content Management

### MDX Editor
**Библиотека**: `@mdxeditor/editor`  
**Роль**: Rich text editor для домашних заданий  
**ADR**: [[ADR-005 MDX для домашних заданий]]

**Компоненты**:
- `components/ui/markdown-editor.tsx` - редактор
- `components/ui/markdown-viewer.tsx` - просмотр

### React Markdown
**Библиотека**: `react-markdown`  
**Роль**: Рендеринг Markdown

**Плагины**:
- `remark-gfm` - GitHub Flavored Markdown
- `rehype-highlight` - подсветка кода

## Development Tools

### Testing

#### Jest
**Версия**: `^29.0.0`  
**Роль**: Unit testing

**Конфигурация**: `jest.config.js`, `jest.setup.js`

**Файлы**: `__tests__/unit/`, `__tests__/integration/`

#### Playwright
**Версия**: `^1.40.0`  
**Роль**: E2E testing

**Конфигурация**: `playwright.config.ts`

**Файлы**: `e2e/*.spec.ts`

#### MSW (Mock Service Worker)
**Версия**: `^2.0.0`  
**Роль**: API mocking для тестов

**Файлы**: `__tests__/mocks/`

### Linting & Formatting

#### ESLint
**Версия**: Встроен в Next.js  
**Конфигурация**: `.eslintrc.json`

#### Prettier (опционально)
**Роль**: Code formatting

### Git Hooks

#### Commitlint
**Конфигурация**: `commitlint.config.js`

**Формат**: Conventional Commits
```
feat(admin): add user management
fix(api): resolve auth issue
docs(readme): update setup instructions
```

## DevOps & Deployment

### Docker
**Файлы**: `Dockerfile`, `docker-compose.yml`

**Конфигурация**:
```dockerfile
FROM node:20-alpine
RUN apk add --no-cache libc6-compat
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npx prisma generate
RUN npm run build
EXPOSE 3000
CMD ["npm", "start"]
```

### Environment Variables
**Файл**: `.env` (не в Git), `.env.example` (шаблон)

**Основные переменные**:
```bash
DATABASE_URL=postgresql://...
NEXTAUTH_SECRET=...
NEXTAUTH_URL=https://yourdomain.com
TELEGRAM_BOT_TOKEN=...
GIGACHAT_API_KEY=...
```

### Coolify / Vercel
**Роль**: Hosting и деплой

**Требования**:
- Node.js 20+
- PostgreSQL 12+
- HTTPS для Telegram webhook

## Scheduling & Cron

### node-cron
**Библиотека**: `node-cron`  
**Роль**: Cron jobs для уведомлений

**Файл**: `lib/cron/init.ts`

**Задачи**:
- Напоминания о занятиях (каждые 5 минут)
- Дневные сводки (ежедневно в 7:00)
- Напоминания о ДЗ (каждые 2 часа)

## Package Manager

### npm
**Версия**: `≥8.0.0`  
**Файлы**: `package.json`, `package-lock.json`

**Основные скрипты**:
```json
{
  "dev": "next dev",
  "build": "next build",
  "start": "next start",
  "test": "jest",
  "test:e2e": "playwright test",
  "prisma:generate": "prisma generate",
  "prisma:migrate": "prisma migrate dev"
}
```

## Версии и совместимость

### Node.js
**Требуемая версия**: `≥20.0.0`  
**Рекомендуемая**: `20.x LTS`

### Браузеры
- Chrome/Edge: последние 2 версии
- Firefox: последние 2 версии
- Safari: последние 2 версии
- Mobile: iOS Safari 14+, Chrome Mobile

## Зависимости

### Production Dependencies
```json
{
  "next": "^14.2.0",
  "react": "^18.0.0",
  "react-dom": "^18.0.0",
  "typescript": "^5.2.0",
  "@prisma/client": "^6.7.0",
  "next-auth": "^4.24.0",
  "bcrypt": "^5.1.0",
  "zod": "^3.22.0",
  "react-hook-form": "^7.0.0",
  "@radix-ui/react-*": "latest",
  "tailwindcss": "^3.4.0",
  "@mdxeditor/editor": "^2.0.0",
  "react-markdown": "^9.0.0",
  "node-cron": "^3.0.0"
}
```

### Development Dependencies
```json
{
  "prisma": "^6.7.0",
  "@types/node": "^20.0.0",
  "@types/react": "^18.0.0",
  "jest": "^29.0.0",
  "playwright": "^1.40.0",
  "@testing-library/react": "^14.0.0",
  "eslint": "^8.0.0",
  "eslint-config-next": "14.2.0"
}
```

## Связанные заметки

### ADR
- [[ADR-001 Next.js 14 App Router]]
- [[ADR-002 Prisma ORM]]
- [[ADR-003 NextAuth.js аутентификация]]
- [[ADR-004 Telegram интеграция]]
- [[ADR-005 MDX для домашних заданий]]
- [[ADR-007 Tailwind + Radix UI]]

### Архитектура
- [[Обзор системы]]
- [[База данных]]
- [[Аутентификация]]

### Паттерны
- [[Server Components паттерн]]
- [[Client Components паттерн]]
- [[API Route паттерн]]

## Файлы конфигурации

- `package.json` - зависимости и скрипты
- `tsconfig.json` - TypeScript конфигурация
- `next.config.js` - Next.js настройки
- `tailwind.config.ts` - Tailwind CSS
- `prisma/schema.prisma` - схема БД
- `jest.config.js` - тестирование
- `playwright.config.ts` - E2E тесты
- `commitlint.config.js` - Git commits

---

#architecture #tech-stack #technologies #core

