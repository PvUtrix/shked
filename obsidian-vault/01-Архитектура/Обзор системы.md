# Обзор архитектуры ШКЕД

> Высокоуровневая архитектура системы управления расписанием

## Введение

ШКЕД (SmartSchedule) - современная веб-платформа для управления расписанием занятий в университете МФТИ, построенная на Next.js 14 с использованием App Router, Prisma ORM и PostgreSQL.

## Технологический стек

**Подробно**: [[Технологический стек]]

### Frontend
- **Next.js 14** (App Router) - React фреймворк с SSR/SSG
- **React 18** - UI библиотека
- **TypeScript** - типизация
- **Tailwind CSS** - утилитарные стили
- **Radix UI** - доступные UI компоненты
- **MDXEditor** - редактор Markdown

### Backend
- **Next.js API Routes** - serverless функции
- **NextAuth.js** - аутентификация
- **Prisma ORM** - работа с БД
- **PostgreSQL** - реляционная БД

### Интеграции
- **Telegram Bot API** - уведомления и взаимодействие
- **GigaChat API** - LLM для обработки естественного языка

## Архитектурные решения

### ADR (Architecture Decision Records)

1. [[ADR-001 Next.js 14 App Router]] - использование App Router для маршрутизации
2. [[ADR-002 Prisma ORM]] - выбор Prisma для работы с БД
3. [[ADR-003 NextAuth.js аутентификация]] - аутентификация и авторизация
4. [[ADR-004 Telegram интеграция]] - интеграция Telegram бота
5. [[ADR-005 MDX для домашних заданий]] - использование MDX для контента
6. [[ADR-006 Система подгрупп]] - механизм разделения студентов
7. [[ADR-007 Tailwind + Radix UI]] - UI фреймворки

## Структура приложения

### Директории

```
smartschedule/
├── app/                    # Next.js 14 App Router
│   ├── admin/             # Админ панель
│   ├── student/           # Интерфейс студента
│   ├── lector/            # Интерфейс преподавателя
│   ├── mentor/            # Интерфейс ментора
│   ├── api/               # API routes
│   └── login/             # Аутентификация
├── components/            # React компоненты
│   ├── ui/               # UI компоненты (Radix UI)
│   ├── admin/            # Компоненты админа
│   ├── student/          # Компоненты студента
│   ├── lector/           # Компоненты преподавателя
│   └── auth/             # Компоненты аутентификации
├── lib/                  # Утилиты и библиотеки
│   ├── auth.ts          # NextAuth конфигурация
│   ├── db.ts            # Prisma клиент
│   ├── utils.ts         # Утилиты
│   ├── types.ts         # TypeScript типы
│   ├── telegram/        # Telegram бот
│   └── cron/            # Cron задачи
├── prisma/              # Prisma ORM
│   ├── schema.prisma    # Схема БД
│   └── migrations/      # Миграции
├── hooks/               # React хуки
├── types/               # TypeScript типы
└── public/              # Статические файлы
```

## Модель данных

**Схема**: `prisma/schema.prisma`

### Основные сущности

```mermaid
erDiagram
    User ||--o{ Group : "belongs to"
    User ||--o{ TelegramUser : "has"
    User ||--o{ UserGroup : "has"
    User ||--o{ HomeworkSubmission : "submits"
    User ||--o{ HomeworkComment : "writes"
    User ||--o{ Subject : "teaches (lector)"
    
    Group ||--o{ User : "has students"
    Group ||--o{ Schedule : "has"
    Group ||--o{ Homework : "has"
    Group ||--o{ UserGroup : "has"
    
    Subject ||--o{ Schedule : "scheduled"
    Subject ||--o{ Homework : "has"
    Subject ||--|| User : "taught by (lector)"
    
    Homework ||--o{ HomeworkSubmission : "has"
    
    HomeworkSubmission ||--o{ HomeworkComment : "has"
    
    UserGroup }o--|| User : "student"
    UserGroup }o--|| Group : "group"
```

### Ключевые модели

- [[User]] - пользователи системы (admin, student, lector, mentor)
- [[Group]] - учебные группы
- [[Subject]] - предметы/дисциплины
- [[Schedule]] - расписание занятий
- [[Homework]] - домашние задания
- [[HomeworkSubmission]] - сдачи работ студентами
- [[HomeworkComment]] - комментарии к работам
- [[UserGroup]] - связь студента с группой и подгруппы
- [[TelegramUser]] - привязка Telegram аккаунтов
- [[BotSettings]] - настройки Telegram бота

## Роли пользователей

**Документация**: [[User#Роли пользователей]]

### [[Admin]]
- Управление пользователями, группами, предметами
- Создание расписания
- Настройка Telegram бота
- Доступ: `/admin/*`

### [[Student]]
- Просмотр расписания с учетом подгрупп
- Сдача домашних заданий
- Получение уведомлений через Telegram
- Доступ: `/student/*`

### [[Lector]]
- Создание домашних заданий и расписания
- Проверка работ студентов с комментариями
- Просмотр расписания своих занятий
- Доступ: `/lector/*`

### [[Mentor]]
- Просмотр расписания и ДЗ своих групп
- Помощь студентам с заданиями
- Комментарии к работам студентов
- Доступ: `/mentor/*`

## Основные функции

### 1. [[Управление расписанием]]

Создание, просмотр и редактирование расписания занятий с поддержкой:
- Фильтрации по группам и предметам
- Разделения на подгруппы
- Календарного представления
- Экспорта в различные форматы

**API**: [[Schedules API]]

### 2. [[Система домашних заданий]]

Полный цикл работы с домашними заданиями:
- Создание заданий в MDX формате
- Сдача работ студентами
- Проверка с оценками и feedback
- Инлайн-комментарии к коду
- Отслеживание дедлайнов

**API**: [[Homework API]]  
**ADR**: [[ADR-005 MDX для домашних заданий]]

### 3. [[Telegram интеграция]]

Telegram бот с LLM интеграцией:
- Привязка аккаунтов
- Уведомления о занятиях и дедлайнах
- Запросы на естественном языке
- Дневные и еженедельные сводки
- Настройка уведомлений

**API**: [[Telegram API]]  
**ADR**: [[ADR-004 Telegram интеграция]]

### 4. [[Система подгрупп]]

Гибкое разделение студентов на подгруппы:
- Разные подгруппы для разных предметов
- Автоматическая фильтрация расписания
- Управление составом подгрупп

**ADR**: [[ADR-006 Система подгрупп]]

## Аутентификация и авторизация

**ADR**: [[ADR-003 NextAuth.js аутентификация]]

### NextAuth.js

- **Provider**: Credentials (email + password)
- **Session**: JWT
- **Callbacks**: добавление role и других данных в сессию

```typescript
// lib/auth.ts
export const authOptions: NextAuthOptions = {
  providers: [
    CredentialsProvider({
      async authorize(credentials) {
        // Проверка credentials в БД
        const user = await prisma.user.findUnique({
          where: { email: credentials.email }
        })
        
        // Валидация пароля
        if (user && validatePassword(credentials.password, user.password)) {
          return {
            id: user.id,
            name: user.name,
            email: user.email,
            role: user.role
          }
        }
        
        return null
      }
    })
  ],
  callbacks: {
    async jwt({ token, user }) {
      if (user) {
        token.role = user.role
        token.groupId = user.groupId
      }
      return token
    },
    async session({ session, token }) {
      session.user.role = token.role
      session.user.groupId = token.groupId
      return session
    }
  }
}
```

### Middleware

**Файл**: `middleware.ts`

Защита роутов на уровне middleware:

```typescript
export async function middleware(request: NextRequest) {
  const session = await getToken({ req: request })
  
  if (!session) {
    return NextResponse.redirect(new URL('/login', request.url))
  }
  
  // Проверка роли для защищенных маршрутов
  if (request.nextUrl.pathname.startsWith('/admin')) {
    if (session.role !== 'admin') {
      return NextResponse.redirect(new URL('/unauthorized', request.url))
    }
  }
  
  return NextResponse.next()
}
```

## API Архитектура

**Карта**: [[Карта API]]

### REST API Routes

Все API routes находятся в `app/api/`:

- [[Groups API]] - `/api/groups`
- [[Homework API]] - `/api/homework`
- [[Schedules API]] - `/api/schedules`
- [[Subjects API]] - `/api/subjects`
- [[Telegram API]] - `/api/telegram`
- [[Users API]] - `/api/users`

### Типичный API Route

```typescript
// app/api/example/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { getServerSession } from 'next-auth/next'
import { authOptions } from '@/lib/auth'
import { prisma } from '@/lib/db'

export async function GET(request: NextRequest) {
  // 1. Аутентификация
  const session = await getServerSession(authOptions)
  if (!session?.user) {
    return NextResponse.json({ error: 'Не авторизован' }, { status: 401 })
  }
  
  // 2. Авторизация
  if (session.user.role !== 'admin') {
    return NextResponse.json({ error: 'Доступ запрещен' }, { status: 403 })
  }
  
  // 3. Логика
  const data = await prisma.model.findMany()
  
  // 4. Ответ
  return NextResponse.json({ data })
}
```

## Rendering Strategy

**ADR**: [[ADR-001 Next.js 14 App Router]]

### Server Components (по умолчанию)

Большинство компонентов - Server Components:
- Рендерятся на сервере
- Прямой доступ к БД
- Не увеличивают bundle size
- SEO friendly

```tsx
// app/student/homework/page.tsx
export default async function HomeworkPage() {
  // Прямой доступ к БД в Server Component
  const homework = await prisma.homework.findMany({
    where: { groupId: session.user.groupId }
  })
  
  return <HomeworkList homework={homework} />
}
```

### Client Components

Используются только когда необходимо:
- `useState`, `useEffect`, React хуки
- Интерактивность (клики, формы)
- Browser APIs (window, localStorage)

```tsx
'use client'

import { useState } from 'react'

export function HomeworkSubmissionForm() {
  const [content, setContent] = useState('')
  
  // Интерактивная логика
  async function handleSubmit() {
    await fetch('/api/homework/submit', {
      method: 'POST',
      body: JSON.stringify({ content })
    })
  }
  
  return <form onSubmit={handleSubmit}>...</form>
}
```

## Cron Jobs и Background Tasks

**Файл**: `lib/cron/init.ts`

### Автоматические задачи

```typescript
import cron from 'node-cron'

// Каждые 5 минут - проверка напоминаний о занятиях
cron.schedule('*/5 * * * *', async () => {
  await checkScheduleReminders()
})

// Ежедневно в 7:00 - дневные сводки
cron.schedule('0 7 * * *', async () => {
  await sendDailySummaries()
})

// Каждые 2 часа - напоминания о дедлайнах ДЗ
cron.schedule('0 */2 * * *', async () => {
  await checkHomeworkDeadlines()
})
```

## Безопасность

### Меры безопасности

1. ✅ **NextAuth.js** - защищенная аутентификация
2. ✅ **JWT токены** - безопасные сессии
3. ✅ **Middleware** - защита роутов
4. ✅ **Role-based access control** - авторизация по ролям
5. ✅ **Prisma** - защита от SQL injection
6. ✅ **Environment variables** - конфиденциальные данные
7. ✅ **HTTPS** - шифрованное соединение (production)
8. ✅ **Rate limiting** - защита API (TODO)
9. ✅ **CSRF tokens** - защита форм (TODO)
10. ✅ **Content Security Policy** - XSS защита (TODO)

### Environment Variables

```bash
# Database
DATABASE_URL=postgresql://user:password@localhost:5432/smartschedule

# NextAuth
NEXTAUTH_SECRET=your-secret-key
NEXTAUTH_URL=http://localhost:3000

# Telegram
TELEGRAM_BOT_TOKEN=your-bot-token

# GigaChat (опционально)
GIGACHAT_API_KEY=your-api-key
```

## Deployment

**Документация**: [docs/deployment/](../../docs/deployment/)

### Docker

```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npx prisma generate
RUN npm run build

EXPOSE 3000

CMD ["npm", "start"]
```

### Vercel

- Автодеплой из GitHub
- Edge Functions для API routes
- Automatic HTTPS
- CDN для статики

### Self-hosted

- Docker Compose с PostgreSQL
- Nginx reverse proxy
- PM2 для управления процессом
- Webhook для автодеплоя

## Мониторинг и логирование

### Логирование

```typescript
// Структурированное логирование
console.log('[INFO]', 'User logged in:', { userId, timestamp })
console.error('[ERROR]', 'Failed to fetch homework:', error)
```

### Мониторинг (TODO)

- **Sentry** - отслеживание ошибок
- **Vercel Analytics** - метрики производительности
- **PostHog** - аналитика пользователей

## Производительность

### Оптимизации

1. ✅ **Server Components** - уменьшение bundle size
2. ✅ **Prisma connection pooling** - эффективная работа с БД
3. ✅ **Image optimization** - Next.js Image component
4. ✅ **Code splitting** - автоматическое разделение кода
5. ✅ **Static generation** - где возможно
6. ⏳ **Redis caching** - кэширование (TODO)
7. ⏳ **Database indexing** - индексы БД (частично)

## Тестирование

**Документация**: [docs/development/TESTING.md](../../docs/development/TESTING.md)

### Типы тестов

- **Unit tests** - Jest + React Testing Library
- **Integration tests** - API routes
- **E2E tests** - Playwright
- **Type checking** - TypeScript

```bash
# Запуск тестов
npm run test           # Unit + Integration
npm run test:e2e       # E2E тесты
npm run type-check     # TypeScript проверка
```

## Разработка

### Локальный запуск

```bash
# Установка зависимостей
npm install

# Настройка БД
npx prisma generate
npx prisma migrate dev

# Seed данные (опционально)
npx prisma db seed

# Запуск dev сервера
npm run dev
```

### Workflow

1. Создать ветку от `main`
2. Внести изменения
3. Запустить тесты и линтер
4. Создать Pull Request
5. Code review
6. Merge в `main`
7. Автодеплой

## Связанные заметки

### Карты
- [[Карта проекта]] - навигация по документации
- [[Карта API]] - все API endpoints

### ADR
- Все 7 архитектурных решений в [[07-ADR]]

### Модели
- Все 9 моделей данных в [[05-Модели-данных]]

### API
- Все 6 API документаций в [[03-API]]

### Функции
- Все 4 основные функции в [[06-Функции]]

## Файлы

- **Конфигурация**: `next.config.js`, `tsconfig.json`, `tailwind.config.ts`
- **Аутентификация**: `lib/auth.ts`, `middleware.ts`
- **База данных**: `lib/db.ts`, `prisma/schema.prisma`
- **API**: `app/api/**/*.ts`
- **Компоненты**: `components/**/*.tsx`
- **Типы**: `lib/types.ts`, `types/**/*.ts`

## Официальная документация

- [Next.js Docs](https://nextjs.org/docs)
- [Prisma Docs](https://www.prisma.io/docs)
- [NextAuth.js Docs](https://next-auth.js.org)
- [Tailwind CSS Docs](https://tailwindcss.com/docs)
- [Radix UI Docs](https://www.radix-ui.com)

---

#architecture #overview #system-design #next-js #fullstack

