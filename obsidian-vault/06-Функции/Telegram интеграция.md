# Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

> –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Telegram –±–æ—Ç–∞ —Å LLM –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

## –û–±–∑–æ—Ä

Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è - –≤–∞–∂–Ω–∞—è —á–∞—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã –®–∫–µ–¥, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–∞—è —Å—Ç—É–¥–µ–Ω—Ç–∞–º –∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º —É–¥–æ–±–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞ —á–µ—Ä–µ–∑ GigaChat API.

**ADR**: [[ADR-004 Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è]]

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –î–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ [[Student]]
- üìÖ –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è (—Å–µ–≥–æ–¥–Ω—è/–∑–∞–≤—Ç—Ä–∞/–Ω–µ–¥–µ–ª—è)
- üìù –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π –∏ –¥–µ–¥–ª–∞–π–Ω–æ–≤
- üîî –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–Ω—è—Ç–∏—è—Ö
- ‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –¥–µ–¥–ª–∞–π–Ω–∞—Ö –î–ó
- üí¨ –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —è–∑—ã–∫–µ
- üìä –î–Ω–µ–≤–Ω—ã–µ –∏ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ —Å–≤–æ–¥–∫–∏

### –î–ª—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π [[Teacher]]
- üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–≤–æ–∏—Ö –∑–∞–Ω—è—Ç–∏–π
- üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–Ω—è—Ç–∏—è—Ö
- üì¨ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞—Ö

### –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ [[Admin]]
- üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
- üì¢ –†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –±–æ—Ç–∞
- üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–æ—Ç–∞

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```mermaid
graph TB
    A[Telegram User] -->|–°–æ–æ–±—â–µ–Ω–∏–µ| B[Telegram Bot API]
    B -->|Webhook POST| C[/api/telegram/webhook]
    C -->|–ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–º–∞–Ω–¥—ã| D{–¢–∏–ø –∫–æ–º–∞–Ω–¥—ã?}
    D -->|/start, /help| E[–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç–≤–µ—Ç—ã]
    D -->|/schedule, /homework| F[–ó–∞–ø—Ä–æ—Å –∫ –ë–î]
    D -->|–¢–µ–∫—Å—Ç| G[LLM –æ–±—Ä–∞–±–æ—Ç–∫–∞]
    F -->|–î–∞–Ω–Ω—ã–µ| H[–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ]
    G -->|–ß–µ—Ä–µ–∑ GigaChat| I[–£–º–Ω—ã–π –æ—Ç–≤–µ—Ç]
    H -->|–û—Ç–≤–µ—Ç| J[sendMessage]
    I -->|–û—Ç–≤–µ—Ç| J
    J -->|API Call| B
    B -->|–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ| A
    
    K[Cron Jobs] -->|–ö–∞–∂–¥—ã–µ 5 –º–∏–Ω| L[–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π]
    L -->|–ó–∞ 30 –º–∏–Ω –¥–æ –ø–∞—Ä—ã| J
    
    M[Cron Jobs] -->|–ï–∂–µ–¥–Ω–µ–≤–Ω–æ 7:00| N[–î–Ω–µ–≤–Ω—ã–µ —Å–≤–æ–¥–∫–∏]
    N -->|–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –¥–µ–Ω—å| J
```

## –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

### TelegramUser [[TelegramUser]]
–°–≤—è–∑—å –º–µ–∂–¥—É User —Å–∏—Å—Ç–µ–º—ã –∏ Telegram –∞–∫–∫–∞—É–Ω—Ç–æ–º

```prisma
model TelegramUser {
  id            String   @id
  userId        String   @unique
  telegramId    String   @unique
  chatId        String
  username      String?
  firstName     String?
  lastName      String?
  isActive      Boolean  @default(true)
  notifications Boolean  @default(true)
  createdAt     DateTime
  user          User     @relation(...)
}
```

### BotSettings [[BotSettings]]
–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram –±–æ—Ç–∞

```prisma
model BotSettings {
  id                   String   @id
  telegramBotToken     String?
  openaiApiKey         String?  // GigaChat API Key
  webhookUrl           String?
  isActive             Boolean  @default(false)
  notificationsEnabled Boolean  @default(true)
  reminderMinutes      Int      @default(30)
  dailySummaryTime     String   @default("07:00")
}
```

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 1. Webhook Handler
**–§–∞–π–ª**: `app/api/telegram/webhook/route.ts`

–ü—Ä–∏–Ω–∏–º–∞–µ—Ç updates –æ—Ç Telegram Bot API:
- –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ö–æ–º–∞–Ω–¥—ã (/start, /schedule, etc.)
- Callback queries (–∫–Ω–æ–ø–∫–∏)

```typescript
export async function POST(request: NextRequest) {
  const update = await request.json()
  
  if (update.message) {
    await handleMessage(update.message)
  } else if (update.callback_query) {
    await handleCallbackQuery(update.callback_query)
  }
  
  return NextResponse.json({ ok: true })
}
```

### 2. Commands Handler
**–§–∞–π–ª**: `lib/telegram/commands.ts`

–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞:

```typescript
async function routeCommand(command: string, chatId: string) {
  switch (command) {
    case '/start':
      return handleStart(chatId)
    case '/schedule':
      return handleSchedule(chatId)
    case '/homework':
      return handleHomework(chatId)
    case '/link':
      return handleLink(chatId)
    // ... –¥—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã
  }
}
```

### 3. LLM Integration
**–§–∞–π–ª**: `lib/telegram/llm.ts`

–û–±—Ä–∞–±–æ—Ç–∫–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞ —á–µ—Ä–µ–∑ GigaChat:

```typescript
async function processWithLLM(message: string, context: UserContext) {
  const systemPrompt = buildSystemPrompt(context)
  
  const response = await fetch('https://gigachat.devices.sberbank.ru/api/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${apiKey}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      model: 'GigaChat',
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: message }
      ]
    })
  })
  
  return response.json()
}
```

### 4. Notifications System
**–§–∞–π–ª**: `lib/telegram/notifications.ts`

–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:

```typescript
// –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –∑–∞–Ω—è—Ç–∏–∏
export async function sendScheduleReminder(
  userId: string,
  schedule: Schedule
) {
  const telegramUser = await prisma.telegramUser.findUnique({
    where: { userId }
  })
  
  if (!telegramUser?.notifications) return
  
  await bot.sendMessage(telegramUser.chatId, {
    text: `üìö –ß–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç: ${schedule.subject.name}
üìç ${schedule.location}
üïê ${schedule.startTime}-${schedule.endTime}`,
    parse_mode: 'Markdown'
  })
}
```

### 5. Cron Jobs
**–§–∞–π–ª**: `lib/cron/init.ts`

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏:

```typescript
// –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç - –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
cron.schedule('*/5 * * * *', async () => {
  await checkScheduleReminders()
})

// –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 7:00 - –¥–Ω–µ–≤–Ω—ã–µ —Å–≤–æ–¥–∫–∏
cron.schedule('0 7 * * *', async () => {
  await sendDailySummaries()
})

// –ö–∞–∂–¥—ã–µ 2 —á–∞—Å–∞ - –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –î–ó
cron.schedule('0 */2 * * *', async () => {
  await checkHomeworkDeadlines()
})
```

## –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

#### /start
–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

```
üëã –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç —Å–∏—Å—Ç–µ–º—ã –®–ö–ï–î.

–î–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ –º–Ω–æ–π –ø—Ä–∏–≤—è–∂–∏ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç:
1. –ó–∞–π–¥–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å –Ω–∞ —Å–∞–π—Ç–µ
2. –ü–æ–ª—É—á–∏ —Ç–æ–∫–µ–Ω –ø—Ä–∏–≤—è–∑–∫–∏
3. –û—Ç–ø—Ä–∞–≤—å –º–Ω–µ /link –¢–í–û–ô_–¢–û–ö–ï–ù

–ü–æ—Å–ª–µ –ø—Ä–∏–≤—è–∑–∫–∏ —Ç–µ–±–µ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã:
üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
üìù –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è
üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
```

#### /help
–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥

```
üìö –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:

–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:
/schedule - –ù–∞ —Å–µ–≥–æ–¥–Ω—è
/tomorrow - –ù–∞ –∑–∞–≤—Ç—Ä–∞
/week - –ù–∞ –Ω–µ–¥–µ–ª—é

–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è:
/homework - –ú–æ–∏ –∑–∞–¥–∞–Ω–∏—è
/homework_due - –ë–ª–∏–∂–∞–π—à–∏–µ –¥–µ–¥–ª–∞–π–Ω—ã

–ù–∞—Å—Ç—Ä–æ–π–∫–∏:
/settings - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
/link - –ü—Ä–∏–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç

–ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å, —è –ø–æ–π–º—É! üòä
```

#### /link [token]
–ü—Ä–∏–≤—è–∑–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ –∫ Telegram

```
–î–ª—è –ø—Ä–∏–≤—è–∑–∫–∏:
1. –ü–æ–ª—É—á–∏ —Ç–æ–∫–µ–Ω –Ω–∞ —Å–∞–π—Ç–µ (–ü—Ä–æ—Ñ–∏–ª—å ‚Üí Telegram)
2. –û—Ç–ø—Ä–∞–≤—å: /link –¢–í–û–ô_–¢–û–ö–ï–ù

–¢–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 15 –º–∏–Ω—É—Ç
```

#### /schedule
–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è

```
üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è (04.11.2024):

üïê 10:00-11:30 | –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
üìç –ê—É–¥. 123 | –õ–µ–∫—Ü–∏—è

üïê 12:00-13:30 | –ê–ª–≥–æ—Ä–∏—Ç–º—ã
üìç –ê—É–¥. 456 | –°–µ–º–∏–Ω–∞—Ä (–ø–æ–¥–≥—Ä—É–ø–ø–∞ 2)

üïê 14:00-15:30 | –§–∏–∑–∏–∫–∞
üìç –ê—É–¥. 789 | –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è
```

#### /homework
–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è

```
üìù –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è:

‚ùó –ê–ª–≥–æ—Ä–∏—Ç–º—ã - –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è ‚Ññ1
   –î–µ–¥–ª–∞–π–Ω: 05.11.2024 23:59
   –°—Ç–∞—Ç—É—Å: –ù–µ —Å–¥–∞–Ω–æ
   
‚úÖ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ - –î–ó ‚Ññ3
   –î–µ–¥–ª–∞–π–Ω: 01.11.2024 23:59
   –°—Ç–∞—Ç—É—Å: –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ
   –û—Ü–µ–Ω–∫–∞: 9/10
```

### –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —è–∑—ã–∫

–ë–æ—Ç –ø–æ–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ:

**–ü—Ä–∏–º–µ—Ä—ã**:
- "–ö–æ–≥–¥–∞ –º–æ—è —Å–ª–µ–¥—É—é—â–∞—è –ø–∞—Ä–∞?"
- "–ß—Ç–æ —É –º–µ–Ω—è –∑–∞–≤—Ç—Ä–∞?"
- "–ü–æ–∫–∞–∂–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª—é"
- "–ö–∞–∫–∏–µ –¥–æ–º–∞—à–∫–∏ —É –º–µ–Ω—è –µ—Å—Ç—å?"
- "–ö–æ–≥–¥–∞ —Å–¥–∞–≤–∞—Ç—å –î–ó –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ?"
- "–ì–¥–µ –∑–∞–Ω—è—Ç–∏–µ –ø–æ —Ñ–∏–∑–∏–∫–µ?"

## –ü—Ä–∏–≤—è–∑–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞

### Workflow

```mermaid
graph LR
    A[–°—Ç—É–¥–µ–Ω—Ç –≤ –ø—Ä–æ—Ñ–∏–ª–µ] --> B[–ù–∞–∂–∏–º–∞–µ—Ç "–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω"]
    B --> C[–°–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–æ–∫–µ–Ω TTL 15 –º–∏–Ω]
    C --> D[–°—Ç—É–¥–µ–Ω—Ç –∫–æ–ø–∏—Ä—É–µ—Ç —Ç–æ–∫–µ–Ω]
    D --> E[–û—Ç–∫—Ä—ã–≤–∞–µ—Ç Telegram –±–æ—Ç–∞]
    E --> F[–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç /link TOKEN]
    F --> G[–ë–æ—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω]
    G --> H{–¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω?}
    H -->|–î–∞| I[–°–æ–∑–¥–∞–µ—Ç TelegramUser]
    H -->|–ù–µ—Ç| J[–û—à–∏–±–∫–∞: —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ–∫]
    I --> K[–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ]
```

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞

**–°—Ç—Ä–∞–Ω–∏—Ü–∞**: `/student/profile`, `/teacher/profile`  
**API**: `GET /api/telegram/link`

```typescript
export async function GET(request: NextRequest) {
  const session = await getServerSession()
  
  // –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π —Ç–æ–∫–µ–Ω
  const token = crypto.randomBytes(32).toString('hex')
  
  // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Redis/–ë–î —Å TTL 15 –º–∏–Ω—É—Ç
  await redis.setex(`telegram-link:${token}`, 900, session.user.id)
  
  return NextResponse.json({ token })
}
```

### –ü—Ä–∏–≤—è–∑–∫–∞ —á–µ—Ä–µ–∑ –±–æ—Ç–∞

**–ö–æ–º–∞–Ω–¥–∞**: `/link TOKEN`  
**API**: `POST /api/telegram/link`

```typescript
async function handleLinkCommand(chatId: string, token: string) {
  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω
  const userId = await redis.get(`telegram-link:${token}`)
  
  if (!userId) {
    return bot.sendMessage(chatId, {
      text: '‚ùå –¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏–ª–∏ –∏—Å—Ç–µ–∫'
    })
  }
  
  // –°–æ–∑–¥–∞—Ç—å —Å–≤—è–∑—å
  await prisma.telegramUser.create({
    data: {
      userId,
      telegramId: update.message.from.id.toString(),
      chatId: chatId.toString(),
      username: update.message.from.username,
      firstName: update.message.from.first_name
    }
  })
  
  // –£–¥–∞–ª–∏—Ç—å —Ç–æ–∫–µ–Ω
  await redis.del(`telegram-link:${token}`)
  
  return bot.sendMessage(chatId, {
    text: '‚úÖ –ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω!\n\n–¢–µ–ø–µ—Ä—å —Ç–µ–±–µ –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–æ—Ç–∞.'
  })
}
```

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### 1. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –∑–∞–Ω—è—Ç–∏—è—Ö
**–í—Ä–µ–º—è**: –ó–∞ 30 –º–∏–Ω—É—Ç –¥–æ –Ω–∞—á–∞–ª–∞  
**–ö–æ–º—É**: –°—Ç—É–¥–µ–Ω—Ç—ã –≥—Ä—É–ø–ø—ã + –õ–µ–∫—Ç–æ—Ä  
**Cron**: –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç

```typescript
async function checkScheduleReminders() {
  const now = new Date()
  const in30Minutes = new Date(now.getTime() + 30 * 60000)
  
  const upcomingSchedules = await prisma.schedule.findMany({
    where: {
      date: { gte: now, lte: in30Minutes },
      isActive: true
    },
    include: {
      subject: { include: { teacher: { include: { telegramUser: true }}}},
      group: { include: { users: { include: { telegramUser: true }}}}
    }
  })
  
  for (const schedule of upcomingSchedules) {
    // –£–≤–µ–¥–æ–º–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
    for (const student of schedule.group.users) {
      await sendScheduleReminder(student.id, schedule)
    }
    
    // –£–≤–µ–¥–æ–º–∏—Ç—å –ª–µ–∫—Ç–æ—Ä–∞
    await sendScheduleReminder(schedule.subject.teacher.id, schedule)
  }
}
```

### 2. –î–Ω–µ–≤–Ω—ã–µ —Å–≤–æ–¥–∫–∏
**–í—Ä–µ–º—è**: –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 7:00  
**–ö–æ–º—É**: –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å Telegram  
**Cron**: `0 7 * * *`

```typescript
async function sendDailySummaries() {
  const users = await prisma.user.findMany({
    where: {
      telegramUser: { notifications: true }
    },
    include: { telegramUser: true, group: true }
  })
  
  for (const user of users) {
    const todaySchedule = await getStudentSchedule(user.id, ...)
    
    if (todaySchedule.length > 0) {
      const message = `üåÖ –î–æ–±—Ä–æ–µ —É—Ç—Ä–æ!\n\nüìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:\n\n` +
        todaySchedule.map(s => 
          `üïê ${s.startTime}-${s.endTime} | ${s.subject.name}\n` +
          `üìç ${s.location}`
        ).join('\n\n')
      
      await bot.sendMessage(user.telegramUser.chatId, { text: message })
    }
  }
}
```

### 3. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –¥–µ–¥–ª–∞–π–Ω–∞—Ö –î–ó
**–í—Ä–µ–º—è**: –ó–∞ 24—á –∏ –∑–∞ 2—á –¥–æ –¥–µ–¥–ª–∞–π–Ω–∞  
**–ö–æ–º—É**: –°—Ç—É–¥–µ–Ω—Ç—ã  
**Cron**: –ö–∞–∂–¥—ã–µ 2 —á–∞—Å–∞

```typescript
async function checkHomeworkDeadlines() {
  const now = new Date()
  const in24Hours = new Date(now.getTime() + 24 * 60 * 60000)
  const in2Hours = new Date(now.getTime() + 2 * 60 * 60000)
  
  // –ù–∞–π—Ç–∏ –î–ó —Å –¥–µ–¥–ª–∞–π–Ω–æ–º –≤ –±–ª–∏–∂–∞–π—à–∏–µ 24 —á–∞—Å–∞
  const urgentHomework = await prisma.homework.findMany({
    where: {
      deadline: { gte: now, lte: in24Hours },
      isActive: true
    },
    include: {
      submissions: {
        where: { status: 'NOT_SUBMITTED' },
        include: { user: { include: { telegramUser: true }}}
      }
    }
  })
  
  for (const hw of urgentHomework) {
    for (const submission of hw.submissions) {
      const timeLeft = hw.deadline.getTime() - now.getTime()
      const hoursLeft = Math.floor(timeLeft / (60 * 60000))
      
      await bot.sendMessage(submission.user.telegramUser.chatId, {
        text: `‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ!\n\n` +
              `üìù ${hw.title}\n` +
              `‚è≥ –û—Å—Ç–∞–ª–æ—Å—å: ${hoursLeft} —á–∞—Å–æ–≤\n` +
              `üìÖ –î–µ–¥–ª–∞–π–Ω: ${format(hw.deadline, 'dd.MM.yyyy HH:mm')}`
      })
    }
  }
}
```

### 4. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ä–∞–±–æ—Ç
**–°–æ–±—ã—Ç–∏–µ**: –ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã –ª–µ–∫—Ç–æ—Ä–æ–º  
**–ö–æ–º—É**: –°—Ç—É–¥–µ–Ω—Ç

```typescript
// –í API route –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã
await prisma.homeworkSubmission.update({
  where: { id: submissionId },
  data: { status: 'REVIEWED', grade, feedback }
})

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
const telegramUser = await prisma.telegramUser.findUnique({
  where: { userId: submission.userId }
})

if (telegramUser?.notifications) {
  await bot.sendMessage(telegramUser.chatId, {
    text: `‚úÖ –†–∞–±–æ—Ç–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞!\n\n` +
          `üìù ${homework.title}\n` +
          `‚≠ê –û—Ü–µ–Ω–∫–∞: ${grade}/10\n\n` +
          `–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å feedback –º–æ–∂–Ω–æ –≤ –ø—Ä–æ—Ñ–∏–ª–µ`
  })
}
```

## API Endpoints

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: [[Telegram API]]

```typescript
// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞ (admin only)
GET /api/telegram/config
POST /api/telegram/config

// –ü—Ä–∏–≤—è–∑–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞
GET /api/telegram/link - –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω
POST /api/telegram/link - –ø—Ä–∏–≤—è–∑–∞—Ç—å –ø–æ —Ç–æ–∫–µ–Ω—É

// Webhook
POST /api/telegram/webhook - –ø–æ–ª—É—á–µ–Ω–∏–µ updates –æ—Ç Telegram

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (admin only)
POST /api/telegram/send

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (admin only)
GET /api/telegram/stats
```

## –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –î–ª—è –∞–¥–º–∏–Ω–∞

```typescript
const stats = await prisma.telegramUser.aggregate({
  _count: { id: true },
  where: { isActive: true }
})

const totalUsers = await prisma.user.count()

console.log({
  connectedUsers: stats._count.id,
  totalUsers,
  connectionRate: (stats._count.id / totalUsers) * 100
})
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ú–µ—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

1. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ Telegram webhook** (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω secret token)
2. ‚úÖ **–¢–æ–∫–µ–Ω—ã –ø—Ä–∏–≤—è–∑–∫–∏ —Å TTL** (15 –º–∏–Ω—É—Ç)
3. ‚úÖ **Rate limiting** –Ω–∞ API routes
4. ‚úÖ **–°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞**
5. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞** (role-based)
6. ‚úÖ **–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ Bot Token** –≤ –ë–î
7. ‚úÖ **HTTPS –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω** –¥–ª—è webhook

### Environment Variables

```bash
# Telegram
TELEGRAM_BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrSTUvwxYZ

# GigaChat (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –≤ –ë–î)
GIGACHAT_API_KEY=your_gigachat_key

# Webhook
NEXTAUTH_URL=https://shked.example.com
```

## Troubleshooting

### –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook URL –¥–æ—Å—Ç—É–ø–µ–Ω
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ Bot Token –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ `/api/telegram/webhook`

### –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏–≤—è–∑–∫–∞
- –¢–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω —Ç–æ–ª—å–∫–æ 15 –º–∏–Ω—É—Ç
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Redis/–ë–î –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤

### –ù–µ –ø—Ä–∏—Ö–æ–¥—è—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ notifications = true
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –±–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω (isActive)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ cron –∑–∞–¥–∞—á–∏ –∑–∞–ø—É—â–µ–Ω—ã

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏

### –ú–æ–¥–µ–ª–∏
- [[TelegramUser]] - —Å–≤—è–∑—å —Å Telegram
- [[BotSettings]] - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞
- [[User]] - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∏—Å—Ç–µ–º—ã
- [[Schedule]] - —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- [[Homework]] - –î–ó –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### –§—É–Ω–∫—Ü–∏–∏
- [[–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º]] - —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤ –±–æ—Ç–µ
- [[–°–∏—Å—Ç–µ–º–∞ –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π]] - –î–ó –≤ –±–æ—Ç–µ

### API
- [[Telegram API]] - –¥–µ—Ç–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### ADR
- [[ADR-004 Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è]] - –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### –†–æ–ª–∏
- [[Admin]] - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º
- [[Student]] - –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–æ—Ç–∞
- [[Teacher]] - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–Ω—è—Ç–∏—è—Ö

## –§–∞–π–ª—ã

- **–ú–æ–¥–µ–ª–∏**: `prisma/schema.prisma`
- **API**: `app/api/telegram/**/*.ts`
- **–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞**: `lib/telegram/**/*.ts`
- **Cron**: `lib/cron/init.ts`
- **–ù–∞—Å—Ç—Ä–æ–π–∫–∏**: `app/admin/settings/page.tsx`

## –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [docs/features/TELEGRAM_BOT.md](../../docs/features/TELEGRAM_BOT.md)
- [Telegram Bot API](https://core.telegram.org/bots/api)
- [GigaChat API](https://developers.sber.ru/docs/ru/gigachat/overview)

---

#function #telegram #bot #llm #notifications #integration

