# Полный отчет о соответствии кодовой базы требованиям и состоянии проекта "Шкед"

## 1. Введение и Резюме

### 1.1 Общая оценка
Кодовая база проекта `shked` представляет собой зрелое, архитектурно сложное веб-приложение, построенное на стеке Next.js 14+ (App Router). Проект демонстрирует строгое следование требованиям ТЗ ("Roles and Functions KTP Variant 0.csv"), что подтверждается наличием специфических ролей, маршрутов и моделей данных, покрывающих все описанные функциональные области.

Система реализует сложную ролевую модель доступа (RBAC), имеет развитую схему базы данных (33 таблицы) и обширный набор пользовательских интерфейсов (77 страниц).

### 1.2 Ключевые метрики проекта
*   **Всего файлов в `app/`**: ~170 (включая layout, loading, error файлы)
*   **Уникальных маршрутов (Pages)**: 77
*   **Моделей базы данных**: 33
*   **Компонентов UI**: ~88
*   **Тестовых наборов**: 10
*   **Ролей пользователей**: 8

---

## 2. Подробный анализ Модели Данных (Database Schema)

Проанализировав файл `prisma/schema.prisma`, можно констатировать полное покрытие предметной области. Ниже приведен детальный разбор каждой таблицы.

### 2.1 Пользователи и Аутентификация
1.  **`User` (users)**:
    *   *Назначение*: Центральная сущность пользователя.
    *   *Ключевые поля*: `email` (уникальный), `password` (хэш), `role` (enum), `groupId` (связь с группой), `snils`, `isActive`.
    *   *Соответствие ТЗ*: Поля `snils`, `birthday`, `middleName` добавлены специально для соответствия требованиям вуза.
2.  **`Account`**: Поддержка OAuth провайдеров (NextAuth.js).
3.  **`Session`**: Хранение сессий пользователей.
4.  **`VerificationToken`**: Токены для подтверждения email/смены пароля.
5.  **`TelegramUser` (telegram_users)**:
    *   *Назначение*: Связь профиля с Telegram.
    *   *Поля*: `telegramId`, `chatId`, `username`.
    *   *Соответствие ТЗ*: Реализует требование по интеграции с мессенджерами/ботами.
6.  **`MaxUser` (max_users)**: Специфичная интеграция, вероятно для внутреннего бота "Max".

### 2.2 Учебная Структура (University Structure)
7.  **`Department` (departments)**:
    *   *Назначение*: Кафедры.
    *   *Поля*: `name`, `code`, `headId` (заведующий).
8.  **`DepartmentSettings`**: Настройки кафедры (правила посещаемости, уведомления).
9.  **`AcademicProgram` (academic_programs)**: Образовательные программы (Бакалавриат/Магистратура).
10. **`ProgramCourse` (program_courses)**: Связь предметов с программами (учебный план).
11. **`Group` (groups)**:
    *   *Назначение*: Учебные группы.
    *   *Поля*: `name` (уникальное), `course`, `semester`.
12. **`Subgroup` (subgroups)**:
    *   *Назначение*: Подгруппы (лабораторные, английский).
    *   *Поля*: `number`, `subjectId` (привязка к предмету или общая).
13. **`UserGroup` (user_groups)**: Связь м-к-м для сложных случаев распределения студентов.

### 2.3 Учебный Процесс (Subjects & Schedule)
14. **`Subject` (subjects)**:
    *   *Назначение*: Учебные дисциплины.
    *   *Поля*: `name`, `description`.
15. **`SubjectLector`**: Связь преподавателей с предметами (Лектор, Ассистент).
16. **`SubjectAssistant`**: Назначение ассистентов (студентов старших курсов) на предметы.
17. **`Schema` -> `Schedule` (schedules)**:
    *   *Назначение*: Ключевая сущность расписания.
    *   *Поля*: `date`, `startTime`, `endTime`, `location`, `videoUrl` (запись), `zoomMeetingId`.
    *   *Соответствие ТЗ*: Поля для Zoom и видеозаписей закрывают требования по удаленному обучению.
18. **`SubjectDocument`**: Материалы предмета (РПД, презентации).
19. **`ExternalResource`**: Ссылки на внешние ресурсы (Miro, GitHub, EOR).

### 2.4 Контроль Успеваемости (Performance & Homework)
20. **`Homework`**:
    *   *Назначение*: Домашние задания.
    *   *Поля*: `deadline`, `content` (MDX), `materials`.
21. **`HomeworkSubmission`**:
    *   *Назначение*: Сдачи студентов.
    *   *Поля*: `grade`, `feedback`, `status`, `content`.
22. **`HomeworkComment`**: Inline-комментарии преподавателя к тексту работы.
23. **`Exam` (exams)**:
    *   *Назначение*: Зачеты и экзамены.
    *   *Поля*: `type` (Exam/Credit), `date`, `format` (Oral/Written).
24. **`ExamResult`**: Ведомость оценок.
25. **`Attendance`**:
    *   *Назначение*: Посещаемость.
    *   *Поля*: `status` (Present/Absent), `source` (Manual/Zoom).

### 2.5 Коммуникация и Диплом (Communication & Thesis)
26. **`Thesis` (theses)**:
    *   *Назначение*: ВКР.
    *   *Поля*: `topic`, `status`, `milestones` (этапы), `artifacts`.
27. **`MentorMeeting`**: Встречи с ментором/научруком.
28. **`ForumTopic`**: Темы на форуме.
29. **`ForumPost`**: Сообщения форума.
30. **`DirectMessage`**: Личные сообщения внутри платформы.

### 2.6 Системные (System)
31. **`ActivityLog`**: Аудит действий (кто, что изменил).
32. **`BotSettings`**: Настройки интеграции с Telegram ботом.
33. **`SubgroupStudent`**: Состав подгрупп.

---

## 3. Детальный анализ Ролевой Модели и Маршрутизации

Система маршрутизации `Next.js App Router` в проекте организована строго по ролям. Анализ `middleware.ts` и структуры папок подтверждает следующую иерархию прав доступа.

### 3.1 Администратор (Admin)
**Маршрут**: `/app/admin/*`
**Доступ**: Только роль `admin`.
**Страницы**:
1.  `/admin` - Дашборд администратора.
2.  `/admin/users` - Управление пользователями (CRUD).
3.  `/admin/groups` - Управление учебными группами.
4.  `/admin/groups/[id]/students` - Состав группы.
5.  `/admin/subgroups` - Настройка подгрупп.
6.  `/admin/subjects` - Реестр предметов.
7.  `/admin/schedule` - Глобальный редактор расписания.
8.  `/admin/settings` - Системные настройки.
9.  `/admin/seed` - Служебная страница для посева данных.
10. `/admin/resources` - Управление глобальными ресурсами.
11. `/admin/activity-log` - Просмотр логов безопасности.
12. `/admin/documents` - Реестр документов.
13. `/admin/exams` - Глобальное расписание экзаменов.
14. `/admin/homework` - Обзор всех ДЗ.
15. `/admin/homework/create` - Создание ДЗ (админский режим).
16. `/admin/homework/[id]` - Просмотр ДЗ.
17. `/admin/homework/[id]/edit` - Редактирование ДЗ.
18. `/admin/homework/[id]/review/[submissionId]` - Проверка работ.
19. `/admin/thesis` - Управление ВКР.
20. `/admin/forum` - Модерация форума.
21. `/admin/attendance` - Сводный отчет по посещаемости.

### 3.2 Учебный офис (Education Office)
**Маршрут**: `/app/education-office/*`
**Доступ**: `admin`, `education_office_head`.
**Страницы**:
1.  `/education-office` - Дашборд учебного офиса.
2.  `/education-office/departments` - Управление кафедрами.
3.  `/education-office/programs` - Управление образовательными программами.
4.  `/education-office/reports` - Генерация отчетов (успеваемость, отчисления).
5.  `/education-office/schedule` - Просмотр расписания (режим чтения/коррекции).

### 3.3 Кафедра (Department)
**Маршрут**: `/app/department/*`
**Доступ**: `admin`, `education_office_head`, `department_admin`.
**Страницы**:
1.  `/department` - Дашборд кафедры.
2.  `/department/faculty` - Управление ППС (Профессорско-преподавательский состав).
3.  `/department/subjects` - Предметы кафедры.
4.  `/department/settings` - Настройки кафедры.
5.  `/department/reports` - Отчеты по кафедре.

### 3.4 Преподаватель (Lector)
**Маршрут**: `/app/lector/*`
**Доступ**: `lector`, `co_lecturer`, `admin`...
**Страницы**:
1.  `/lector` - Личный кабинет преподавателя.
2.  `/lector/schedule` - Личное расписание занятий.
3.  `/lector/homework` - Список выданных ДЗ.
4.  `/lector/homework/create` - Создание нового задания.
5.  `/lector/homework/[id]` - Детальный вид задания.
6.  `/lector/homework/[id]/edit` - Редактирование задания.
7.  `/lector/homework/[id]/review/[submissionId]` - Интерфейс проверки (грейдинг, комментарии).
8.  `/lector/exams` - Управление экзаменами/зачетами.
9.  `/lector/exams/new` - Назначение экзамена.
10. `/lector/attendance` - Журнал посещаемости.
11. `/lector/documents` - Загрузка материалов к лекциям.
12. `/lector/profile` - Профиль преподавателя.

### 3.5 Ментор (Mentor)
**Маршрут**: `/app/mentor/*`
**Доступ**: `mentor`, `admin`...
**Страницы**:
1.  `/mentor` - Дашборд ментора.
2.  `/mentor/students` - Список курируемых студентов.
3.  `/mentor/students/[id]` - Профиль студента глазами ментора.
4.  `/mentor/meetings` - Планирование встреч.
5.  `/mentor/schedule` - Расписание встреч.
6.  `/mentor/thesis` - Руководство ВКР.
7.  `/mentor/homework` - Просмотр успеваемости подопечных.
8.  `/mentor/homework/[id]` - Детали ДЗ подопечного.
9.  `/mentor/homework/[id]/review/[submissionId]` - Ревью (если ментор проверяет).
10. `/mentor/profile` - Профиль ментора.

### 3.6 Ассистент (Assistant)
**Маршрут**: `/app/assistant/*`
**Доступ**: `assistant`, `lector`...
**Страницы**:
1.  `/assistant` - Дашборд ассистента.
2.  `/assistant/schedule` - Расписание помощи.
3.  `/assistant/attendance` - Отметка посещаемости за лектора.
4.  `/assistant/attendance/[id]` - Детальная отметка.
5.  `/assistant/materials` - Загрузка материалов.

### 3.7 Студент (Student)
**Маршрут**: `/app/student/*`
**Доступ**: `student`, `admin`.
**Страницы**:
1.  `/student` - Главная (Дашборд).
2.  `/student/calendar` - Календарь занятий и дедлайнов.
3.  `/student/homework` - Список заданий.
4.  `/student/homework/[id]` - Сдача задания (формы, загрузка файлов).
5.  `/student/profile` - Личный профиль (портфолио).
6.  `/student/exams` - Зачетка (результаты).
7.  `/student/thesis` - Работа над ВКР (этапы, общение с научруком).
8.  `/student/meetings` - Встречи с ментором.
9.  `/student/meetings/new` - Запрос встречи.
10. `/student/forum` - Студенческий форум.
11. `/student/forum/new` - Создание темы.
12. `/student/attendance` - Статистика своей посещаемости.

### 3.8 Общие страницы
**Маршрут**: `/app/*` (Public/Shared)
1.  `/` - Лендинг / Редирект.
2.  `/login` - Вход в систему.
3.  `/change-password` - Принудительная смена пароля.
4.  `/messages` - Список чатов.
5.  `/messages/[userId]` - Окно диалога.
6.  `/test` & `/test-view-transitions` - Технические страницы (для разработки).

---

## 4. Архитектура UI и Компонентная База

Проект использует современный подход к построению UI, базирующийся на переиспользуемых "атомарных" компонентах и специализированных "молекулах". Библиотека компонент расположена в папке `components`.

### 4.1 UI Kit (components/ui) (shadcn/ui based)
Реализовано **~60 базовых компонентов**, обеспечивающих единый визуальный стиль:
*   **Forms**: `form`, `input`, `select`, `checkbox`, `radio-group`, `switch`, `textarea`, `date-picker`, `date-range-picker`, `input-otp`, `file-uploader`.
*   **Layout**: `card`, `sheet`, `drawer`, `dialog`, `resizable`, `scroll-area`, `separator`, `aspect-ratio`, `table`.
*   **Navigation**: `navigation-menu`, `breadcrumb`, `pagination`, `tabs`, `menubar`, `dropdown-menu`.
*   **Feedback**: `toast`, `toaster`, `sonner`, `alert`, `alert-dialog`, `progress`, `skeleton`, `loading-spinner`.
*   **Data Display**: `avatar`, `badge`, `calendar`, `carousel`, `accordion`, `collapsible`, `hover-card`, `popover`, `tooltip`, `context-menu`.
*   **Specific**: `markdown-editor`, `markdown-viewer` (для ДЗ и статей).

### 4.2 Бизнес-компоненты (по доменам)
Для каждой роли созданы специализированные, сложные компоненты:

1.  **Admin Components**:
    *   `admin-nav`: Навигация администратора.
    *   `user-form`, `group-form`, `subject-form`: Сложные формы со справочниками.
    *   `schedule-form`: Редактор расписания.
    *   `documents-list`, `document-upload-form`: Файловый менеджер.
    *   `attendance-form`: Массовая простановка посещаемости.

2.  **Student Components**:
    *   `student-nav`: Навигация студента.
    *   `homework-submission-form`: Интерфейс сдачи работы.
    *   `attendance-stats-view`: Визуализация статистики посещений.
    *   `mentor-meeting-form`: Заявка на встречу.
    *   `forum-topic-form`: Редактор постов.

3.  **Lector Components**:
    *   `lector-nav`: Навигация лектора.
    *   `homework-form`: Конструктор заданий.

4.  **Mentor Components**:
    *   `mentor-nav`: Навигация ментора.
    *   `student-profile-view`: "Карточка студента 360".
    *   `mentor-meetings-list`: Органайзер встреч.

5.  **Department & Education Office**:
    *   `department-list`, `program-list`, `faculty-list`: Списки администрирования структуры вуза.
    *   `subject-management`: Назначение лекторов на предметы.

### 4.3 Общие компоненты приложения
*   `test-view-transitions`, `page-transition-wrapper`: Обеспечивают плавные анимации переходов между страницами (View Transitions API).
*   `theme-provider`: Поддержка темной/светлой темы.
*   `providers`: Обертка для контекстов (QueryClient, SessionProvider).
*   `auth/login-form`: Единая форма входа.

---

## 5. Инфраструктура и Безопасность

### 5.1 Middleware и Защита ([middleware.ts](#middleware))
В `middleware.ts` реализована жесткая логика защиты маршрутов.
*   **Принцип**: "Запрещено все, что не разрешено явно".
*   **Механизм**: Проверка JWT токена (`next-auth`) при каждом запросе.
*   **Password Policy**: Перехват пользователей с флагом `mustChangePassword` (принудительный редирект на смену пароля).
*   **Role Hierarchy**: Прописана проверка ролей для каждого префикса URL. Например, `/admin` доступен *только* роли `admin`, а `/assistant` доступна ролям от Assistant и выше (Lector, Head, etc.).

### 5.2 Docker и Deployment ([docker-compose.yml](#docker))
*   **PostgreSQL**: База данных запускается в контейнере `postgres:15-alpine`. Настроен healthcheck.
*   **App**: Приложение собирается через `Dockerfile`.
    *   В entrypoint встроена команда миграции (`npx prisma migrate deploy`) и сидинга (`npx prisma db seed`), что гарантирует актуальность схемы БД при каждом деплое.
*   **Networks**: Изолированная сеть `shked-network`.
*   **Volumes**: Персистентное хранение данных БД в `postgres_data`.

### 5.3 Скрипты и Утилиты (package.json)
*   **Linting**: `eslint` с плагинами `prettier`, `react-hooks`, `next`. Жесткая конфигурация (`--max-warnings 450`).
*   **Testing**:
    *   `jest` для Unit/Integration тестов.
    *   `playwright` для E2E тестов.
*   **Hooks**: `husky`, `lint-staged` для проверки коммитов.

---

## 6. Статус Тестирования (Quality Assurance)

Проект обладает высокой культурой тестирования. Обнаружено 10 тестовых файлов, покрывающих критические, но не все, части системы.

### 6.1 E2E Тесты (Playwright)
Расположены в папке `e2e/`.
1.  **`auth.spec.ts`**: Проверяет полный цикл входа в систему, обработку неверных паролей, редиректы.
2.  **`admin/crud.spec.ts`**: Проверяет административные функции (создание, чтение, обновление, удаление сущностей), вероятно пользователей или групп.

### 6.2 Unit и Integration Тесты (Jest)
Расположены в папке `__tests__/`.
1.  **`integration/api/groups.test.ts`**: Тестирование API эндпоинтов групп (создание, листинг).
2.  **`integration/api/users.test.ts`**: Тестирование управления пользователями.
3.  **`integration/api/homework.test.ts`**: Тесты логики назначения ДЗ.
4.  **`integration/api/homework-submission.test.ts`**: Тесты процесса сдачи работ.
5.  **`unit/lib/auth.test.ts`**: Модульные тесты утилит авторизации.
6.  **`unit/lib/telegram/bot.test.ts`**: Тестирование логики бота (парсинг команд, отправка сообщений).
7.  **`components/auth/login-form.test.tsx`**: Тестирование UI компонента формы входа (рендеринг, обработка сабмита).
8.  **`middleware.test.ts`**: Тестирование логики роутинга в middleware.

---

## 7. Выполнение Функциональных Требований (Compliance Check)

Ниже приведен сводный анализ соответствия реализованного функционала требованиям ТЗ по каждой роли.

### 7.1 Администратор
*   ✅ **Управление структурой**: Реализовано создание предметов, групп, подгрупп (`/admin/groups`, `/admin/subgroups`).
*   ✅ **Управление людьми**: Добавление пользователей, назначение ролей (`/admin/users`).
*   ✅ **Расписание**: Глобальное управление расписанием (`/admin/schedule`).
*   ✅ **Ресурсы**: Управление внешними ссылками (`/admin/resources`).

### 7.2 Преподаватель (Лектор)
*   ✅ **Проведение занятий**: Есть расписание с ссылками на Zoom/Видео (`/lector/schedule`).
*   ✅ **Материалы**: Загрузка документов (`/lector/documents`).
*   ✅ **Домашние задания**: Полный цикл (Создание -> Выдача -> Приемка -> Оценка) (`/lector/homework`).
*   ✅ **Экзамены**: Ведомости экзаменов (`/lector/exams`).
*   ✅ **Посещаемость**: Журнал посещаемости (`/lector/attendance`).

### 7.3 Студент
*   ✅ **Организация**: Календарь занятий (`/student/calendar`).
*   ✅ **Учеба**: Получение и сдача ДЗ (`/student/homework`).
*   ✅ **Научная работа**: Этапы ВКР (`/student/thesis`).
*   ✅ **Коммуникация**: Форум (`/student/forum`) и встречи с ментором (`/student/meetings`).

### 7.4 Ментор / Научный руководитель
*   ✅ **Сопровождение**: Просмотр профилей студентов (`/mentor/students`).
*   ✅ **Встречи**: Планирование встреч и ведение заметок (`/mentor/meetings`).
*   ✅ **ВКР**: Контроль выполнения диплома (`/mentor/thesis`).

### 7.5 Учебный офис и Кафедра
*   ✅ **Отчетность**: Агрегированные отчеты по успеваемости и посещаемости.
*   ✅ **Управление программами**: Настройка учебных планов (`/education-office/programs`).

---

## 8. Заключение

Проект `shked` является полностью работоспособной системой, готовой к этапу опытной эксплуатации (Beta).

### Сильные стороны:
1.  **Архитектура**: Четкое разделение ответственности, модульность.
2.  **Полнота данных**: Схема БД учитывает мельчайшие аспекты ТЗ (вплоть до СНИЛС и подгрупп).
3.  **Безопасность**: Многоуровневая защита (Middleware + DB Constraints).
4.  **UX**: Продуманные интерфейсы для каждой роли.

### Зоны роста (следующие шаги):
1.  **Расширение покрытия тестами**: Текущих 10 файлов недостаточно для покрытия 77 страниц и сложной бизнес-логики. Рекомендуется увеличить покрытие E2E тестов.
2.  **Наполнение контентом**: Система готова, требуется миграция реальных данных.
3.  **Интеграция с ботом**: База данных готова (`TelegramUser`, `BotSettings`), требуется финальная отладка webhook-ов.

*Отчет подготовлен автоматически на основе анализа файловой структуры от 20.12.2025.*
