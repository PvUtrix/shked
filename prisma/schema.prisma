generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "linux-musl-arm64-openssl-3.0.x", "darwin-arm64"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                  String               @id @default(cuid())
  name                String?
  email               String               @unique
  emailVerified       DateTime?
  image               String?
  password            String
  firstName           String?
  lastName            String?
  middleName          String? // Отчество
  birthday            DateTime? // Дата рождения
  snils               String? // СНИЛС (только цифры)
  sex                 String? // Пол (male/female)
  role                String               @default("student") // admin, student, lector, mentor, assistant, co_lecturer, education_office_head, department_admin
  groupId             String?
  canHelp             String? // Чем могу быть полезен
  lookingFor          String? // Что ищу
  mentorGroupIds      Json? // Группы для ментора (массив ID групп)
  status              String               @default("ACTIVE") // ACTIVE, EXPELLED, ACADEMIC_LEAVE
  isActive            Boolean              @default(true)
  mustChangePassword  Boolean              @default(false) // Принудительная смена пароля при следующем логине
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  accounts            Account[]
  sessions            Session[]
  userGroups          UserGroup[]
  group               Group?               @relation(fields: [groupId], references: [id])
  telegramUser        TelegramUser?
  maxUser             MaxUser?
  homeworkSubmissions HomeworkSubmission[]
  homeworkComments    HomeworkComment[]    @relation("HomeworkCommentAuthor") // Комментарии к работам
  lectorSubjects      SubjectLector[]
  uploadedDocuments   SubjectDocument[]
  markedAttendance    Attendance[]         @relation("AttendanceMarker")
  studentAttendance   Attendance[]         @relation("AttendanceStudent")
  recordedExams       ExamResult[]         @relation("ExamRecorder")
  studentExams        ExamResult[]         @relation("ExamStudent")
  mentorMeetings      MentorMeeting[]      @relation("MentorMeetings")
  studentMeetings     MentorMeeting[]      @relation("StudentMeetings")
  forumTopics         ForumTopic[]
  forumPosts          ForumPost[]
  subgroupMemberships SubgroupStudent[]
  activityLogs        ActivityLog[]
  sentMessages        DirectMessage[]      @relation("SentMessages")
  receivedMessages    DirectMessage[]      @relation("ReceivedMessages")
  studentThesis       Thesis?              @relation("StudentThesis")
  supervisedTheses    Thesis[]             @relation("SupervisedTheses")
  assistantSubjects   SubjectAssistant[]   @relation("AssistantSubjects")
  assignedAssistants  SubjectAssistant[]   @relation("AssignedAssistants")
  departmentId        String?
  department          Department?          @relation("DepartmentFaculty", fields: [departmentId], references: [id])
  headOfDepartment    Department?          @relation("DepartmentHead")

  @@index([email])
  @@index([role])
  @@index([groupId])
  @@index([isActive])
  @@index([status])
  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Group {
  id          String       @id @default(cuid())
  name        String       @unique
  description String?
  semester    String?
  year        String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  schedules   Schedule[]
  userGroups  UserGroup[]
  users       User[]
  homework    Homework[]
  subgroups   Subgroup[]
  exams       Exam[]
  forumTopics ForumTopic[]

  @@index([isActive])
  @@index([year])
  @@index([semester])
  @@map("groups")
}

model Subject {
  id          String             @id @default(cuid())
  name        String             @unique
  description String?
  instructor  String?
  isActive    Boolean            @default(true)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  schedules   Schedule[]
  homework    Homework[]
  lectors     SubjectLector[]
  assistants  SubjectAssistant[]
  documents   SubjectDocument[]
  resources   ExternalResource[]
  subgroups   Subgroup[]
  exams       Exam[]
  forumTopics ForumTopic[]

  departmentId   String?
  department     Department?     @relation("DepartmentSubjects", fields: [departmentId], references: [id])
  programCourses ProgramCourse[]

  @@index([isActive])
  @@map("subjects")
}

model Schedule {
  id              String             @id @default(cuid())
  subjectId       String
  groupId         String?
  subgroupId      String?
  date            DateTime
  dayOfWeek       Int
  startTime       String
  endTime         String
  location        String?
  eventType       String?
  description     String?
  videoUrl        String? // Ссылка на запись занятия (Яндекс.Диск)
  recordingStatus String? // NOT_RECORDED, RECORDING, UPLOADED, ERROR
  zoomMeetingId   String? // ID встречи Zoom
  isActive        Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  group           Group?             @relation(fields: [groupId], references: [id], onDelete: Cascade)
  subject         Subject            @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  subgroup        Subgroup?          @relation(fields: [subgroupId], references: [id])
  attendance      Attendance[]
  resources       ExternalResource[]

  @@index([subjectId])
  @@index([groupId])
  @@index([subgroupId])
  @@index([date])
  @@index([dayOfWeek])
  @@index([isActive])
  @@map("schedules")
}

model UserGroup {
  id                     String   @id @default(cuid())
  userId                 String
  groupId                String
  subgroupCommerce       Int?
  subgroupTutorial       Int?
  subgroupFinance        Int?
  subgroupSystemThinking Int?
  createdAt              DateTime @default(now())
  group                  Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
  @@map("user_groups")
}

model TelegramUser {
  id            String   @id @default(cuid())
  userId        String   @unique
  telegramId    String   @unique
  chatId        String
  username      String?
  firstName     String?
  lastName      String?
  isActive      Boolean  @default(true)
  notifications Boolean  @default(true)
  createdAt     DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("telegram_users")
}

model MaxUser {
  id            String   @id @default(cuid())
  userId        String   @unique
  maxId         String   @unique
  chatId        String
  username      String?
  firstName     String?
  lastName      String?
  isActive      Boolean  @default(true)
  notifications Boolean  @default(true)
  createdAt     DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("max_users")
}

model BotSettings {
  id                   String   @id @default(cuid())
  telegramBotToken     String?
  telegramBotUsername  String? // Bot username for deep linking (without @)
  telegramWebhookUrl   String?
  maxBotToken          String?
  maxWebhookUrl        String?
  openaiApiKey         String?
  webhookUrl           String? // Deprecated - use telegramWebhookUrl or maxWebhookUrl
  isActive             Boolean  @default(false)
  maxIsActive          Boolean  @default(false)
  notificationsEnabled Boolean  @default(true)
  reminderMinutes      Int      @default(30)
  dailySummaryTime     String   @default("07:00")
  updatedAt            DateTime @updatedAt
  createdAt            DateTime @default(now())

  @@map("bot_settings")
}

model Homework {
  id          String   @id @default(cuid())
  title       String
  description String?
  content     String? // MDX контент задания
  taskUrl     String? // Ссылка на задание
  deadline    DateTime
  materials   Json? // Дополнительные материалы (массив объектов)
  subjectId   String
  groupId     String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  subject     Subject              @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  group       Group?               @relation(fields: [groupId], references: [id], onDelete: Cascade)
  submissions HomeworkSubmission[]

  @@index([subjectId])
  @@index([groupId])
  @@index([deadline])
  @@index([isActive])
  @@map("homework")
}

model HomeworkSubmission {
  id            String    @id @default(cuid())
  homeworkId    String
  userId        String
  content       String? // MDX контент работы студента
  submissionUrl String? // Ссылка на выполненное задание
  status        String    @default("NOT_SUBMITTED") // NOT_SUBMITTED, SUBMITTED, REVIEWED
  grade         Int? // Оценка (1-5 или 1-100)
  comment       String? // Комментарий преподавателя (MDX)
  feedback      String? // Развернутая обратная связь (MDX)
  submittedAt   DateTime?
  reviewedAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  homework Homework          @relation(fields: [homeworkId], references: [id], onDelete: Cascade)
  user     User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments HomeworkComment[] // Inline комментарии к работе

  @@unique([homeworkId, userId])
  @@index([userId])
  @@index([homeworkId])
  @@index([status])
  @@index([submittedAt])
  @@index([reviewedAt])
  @@map("homework_submissions")
}

model HomeworkComment {
  id           String   @id @default(cuid())
  submissionId String // ID работы студента
  authorId     String // ID автора комментария (обычно лектор)
  content      String // Текст комментария
  startOffset  Int // Начальная позиция выделенного текста
  endOffset    Int // Конечная позиция выделенного текста
  selectedText String   @db.Text // Выделенный текст для контекста
  resolved     Boolean  @default(false) // Помечен ли как решенный
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  submission HomeworkSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  author     User               @relation("HomeworkCommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  @@map("homework_comments")
}

// Новые модели для КТП

model SubjectLector {
  id        String   @id @default(cuid())
  subjectId String
  userId    String
  role      String // LECTOR, ASSISTANT, CO_LECTOR
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())

  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  lector  User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([subjectId, userId])
  @@index([subjectId])
  @@index([userId])
  @@index([role])
  @@map("subject_lectors")
}

model SubjectAssistant {
  id         String   @id @default(cuid())
  subjectId  String
  userId     String
  assignedBy String // userId of who assigned the assistant
  assignedAt DateTime @default(now())
  isActive   Boolean  @default(true)

  subject  Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  user     User    @relation("AssistantSubjects", fields: [userId], references: [id], onDelete: Cascade)
  assigner User    @relation("AssignedAssistants", fields: [assignedBy], references: [id], onDelete: Cascade)

  @@unique([subjectId, userId])
  @@index([subjectId])
  @@index([userId])
  @@index([isActive])
  @@map("subject_assistants")
}

model SubjectDocument {
  id         String   @id @default(cuid())
  subjectId  String
  type       String // RPD (Рабочая программа дисциплины), ANNOTATION, MATERIALS
  fileName   String
  fileUrl    String // URL файла в хранилище
  fileSize   Int?
  uploadedBy String // userId
  uploadedAt DateTime @default(now())
  isActive   Boolean  @default(true)

  subject  Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  uploader User    @relation(fields: [uploadedBy], references: [id])

  @@index([subjectId])
  @@index([type])
  @@index([isActive])
  @@map("subject_documents")
}

model ExternalResource {
  id          String   @id @default(cuid())
  subjectId   String?
  scheduleId  String?
  type        String // EOR, ZOOM, CHAT, MIRO, EXCEL, VIDEO, OTHER
  title       String
  url         String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  subject  Subject?  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  schedule Schedule? @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@index([subjectId])
  @@index([scheduleId])
  @@index([type])
  @@index([isActive])
  @@map("external_resources")
}

model Subgroup {
  id          String   @id @default(cuid())
  groupId     String
  subjectId   String? // null = общая подгруппа для всех предметов
  name        String // "Подгруппа 1", "Подгруппа Коммерция" и т.д.
  number      Int // 1, 2, 3...
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  group     Group             @relation(fields: [groupId], references: [id], onDelete: Cascade)
  subject   Subject?          @relation(fields: [subjectId], references: [id])
  students  SubgroupStudent[]
  schedules Schedule[]

  @@unique([groupId, subjectId, number])
  @@index([groupId])
  @@index([subjectId])
  @@index([isActive])
  @@map("subgroups")
}

model SubgroupStudent {
  id         String   @id @default(cuid())
  subgroupId String
  userId     String
  createdAt  DateTime @default(now())

  subgroup Subgroup @relation(fields: [subgroupId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([subgroupId, userId])
  @@index([subgroupId])
  @@index([userId])
  @@map("subgroup_students")
}

model Attendance {
  id         String   @id @default(cuid())
  scheduleId String
  userId     String
  status     String // PRESENT, ABSENT, LATE, EXCUSED
  source     String? // MANUAL, ZOOM_AUTO, VISUAL
  notes      String?
  markedBy   String // userId admin/lector
  markedAt   DateTime @default(now())

  schedule Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  student  User     @relation("AttendanceStudent", fields: [userId], references: [id], onDelete: Cascade)
  marker   User     @relation("AttendanceMarker", fields: [markedBy], references: [id], onDelete: Cascade)

  @@unique([scheduleId, userId])
  @@index([scheduleId])
  @@index([userId])
  @@index([status])
  @@index([markedAt])
  @@map("attendance")
}

model Exam {
  id          String   @id @default(cuid())
  subjectId   String
  groupId     String
  type        String // EXAM, CREDIT, DIFF_CREDIT
  format      String // ORAL, WRITTEN, MIXED
  date        DateTime
  location    String?
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  subject Subject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  group   Group        @relation(fields: [groupId], references: [id], onDelete: Cascade)
  results ExamResult[]

  @@index([subjectId])
  @@index([groupId])
  @@index([date])
  @@index([type])
  @@index([isActive])
  @@map("exams")
}

model ExamResult {
  id         String    @id @default(cuid())
  examId     String
  userId     String
  grade      String? // 5, 4, 3, 2, ЗАЧЕТ, НЕ ЗАЧЕТ
  status     String    @default("NOT_TAKEN") // NOT_TAKEN, PASSED, FAILED
  notes      String?
  takenAt    DateTime?
  recordedBy String // userId lector
  createdAt  DateTime  @default(now())

  exam     Exam @relation(fields: [examId], references: [id], onDelete: Cascade)
  student  User @relation("ExamStudent", fields: [userId], references: [id], onDelete: Cascade)
  recorder User @relation("ExamRecorder", fields: [recordedBy], references: [id], onDelete: Cascade)

  @@unique([examId, userId])
  @@index([examId])
  @@index([userId])
  @@index([status])
  @@index([takenAt])
  @@map("exam_results")
}

model MentorMeeting {
  id          String   @id @default(cuid())
  mentorId    String
  studentId   String
  scheduledAt DateTime
  duration    Int // минуты
  status      String   @default("SCHEDULED") // SCHEDULED, COMPLETED, CANCELLED
  agenda      String?
  notes       String? // Заметки после встречи (MDX)
  location    String?
  meetingType String? // VKR, ACADEMIC, PERSONAL, OTHER
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  mentor  User @relation("MentorMeetings", fields: [mentorId], references: [id], onDelete: Cascade)
  student User @relation("StudentMeetings", fields: [studentId], references: [id], onDelete: Cascade)

  @@index([mentorId])
  @@index([studentId])
  @@index([scheduledAt])
  @@index([status])
  @@map("mentor_meetings")
}

model ForumTopic {
  id        String   @id @default(cuid())
  subjectId String?
  groupId   String?
  authorId  String
  title     String
  content   String   @db.Text
  isPinned  Boolean  @default(false)
  isClosed  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subject Subject?    @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  group   Group?      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  author  User        @relation(fields: [authorId], references: [id], onDelete: Cascade)
  posts   ForumPost[]

  @@index([subjectId])
  @@index([groupId])
  @@index([authorId])
  @@index([isPinned])
  @@index([isClosed])
  @@index([createdAt])
  @@map("forum_topics")
}

model ForumPost {
  id        String   @id @default(cuid())
  topicId   String
  authorId  String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  topic  ForumTopic @relation(fields: [topicId], references: [id], onDelete: Cascade)
  author User       @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([topicId])
  @@index([authorId])
  @@index([createdAt])
  @@map("forum_posts")
}

model ActivityLog {
  id         String   @id @default(cuid())
  userId     String
  action     String // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, SETTINGS_CHANGE
  entityType String? // User, Group, Subject, Schedule, Homework, Settings и т.д.
  entityId   String? // ID затронутой сущности
  ipAddress  String?
  details    Json? // { before: {...}, after: {...}, changes: [...] }
  result     String   @default("SUCCESS") // SUCCESS, FAILURE
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
  @@map("activity_logs")
}

// Личные сообщения
model DirectMessage {
  id         String    @id @default(cuid())
  senderId   String
  receiverId String
  content    String    @db.Text
  isRead     Boolean   @default(false)
  readAt     DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  sender   User @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@index([isRead])
  @@index([createdAt])
  @@map("direct_messages")
}

// Выпускная квалификационная работа
model Thesis {
  id           String    @id @default(cuid())
  studentId    String    @unique
  supervisorId String
  title        String
  abstract     String?   @db.Text
  status       String    @default("IN_PROGRESS") // IN_PROGRESS, SUBMITTED, UNDER_REVIEW, APPROVED, REJECTED, DEFENDED
  milestones   Json? // [{id, name, deadline, status, completedAt, description}]
  artifacts    Json? // [{id, type, url, uploadedAt, description, fileName}]
  defenseDate  DateTime?
  grade        String? // Оценка после защиты
  notes        String?   @db.Text // Заметки научного руководителя (MDX)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  student    User @relation("StudentThesis", fields: [studentId], references: [id], onDelete: Cascade)
  supervisor User @relation("SupervisedTheses", fields: [supervisorId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([supervisorId])
  @@index([status])
  @@index([defenseDate])
  @@map("theses")
}

model Department {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  code        String?  @unique // e.g., "CS", "MATH", "PHYS"
  headId      String?  @unique
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  head             User?               @relation("DepartmentHead", fields: [headId], references: [id])
  faculty          User[]              @relation("DepartmentFaculty")
  subjects         Subject[]           @relation("DepartmentSubjects")
  settings         DepartmentSettings?
  academicPrograms AcademicProgram[]

  @@index([headId])
  @@index([isActive])
  @@map("departments")
}

model DepartmentSettings {
  id           String @id @default(cuid())
  departmentId String @unique

  // Academic policies
  minAttendance Int? @default(75) // Minimum attendance percentage
  passingGrade  Int? @default(3) // Minimum passing grade
  maxAbsences   Int? @default(3) // Max absences before action

  // Notifications
  notifyOnLowGrades  Boolean @default(true)
  notifyOnAbsences   Boolean @default(true)
  emailNotifications Boolean @default(true)

  // Metadata
  contactEmail String?
  contactPhone String?
  office       String?
  website      String?

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@map("department_settings")
}

model AcademicProgram {
  id              String          @id @default(cuid())
  name            String
  degreeType      String // Bachelor, Master, PhD
  departmentId    String
  department      Department      @relation(fields: [departmentId], references: [id])
  requiredCredits Int
  courses         ProgramCourse[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@map("academic_programs")
}

model ProgramCourse {
  id         String          @id @default(cuid())
  programId  String
  program    AcademicProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  subjectId  String
  subject    Subject         @relation(fields: [subjectId], references: [id])
  semester   Int
  isRequired Boolean         @default(true)
  credits    Int

  @@map("program_courses")
}
